\documentclass[dvipdfmx]{beamer}
\usepackage{tutorial}
\title{計算機実験 --- 連立一次方程式の解法}

\begin{document}

\lstset{language={C},basicstyle=\ttfamily\scriptsize,showspaces=false,rulecolor=\color[cmyk]{0, 0.29,0.84,0}}

\begin{frame}
  \titlepage
  \tableofcontents
\end{frame}

\section{物理に現れる連立一次方程式}

\begin{frame}[t,fragile]{連立一次方程式の現れる例}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item 微分方程式の初期値問題の陰解法
  \item 非線形連立方程式に対するニュートン法
    \[ {\bf x}' = {\bf x} - \Big( \frac{\partial {\bf f}({\bf x})}{\partial {\bf x}} \Big)^{-1} {\bf f}({\bf x}) \]
  \item 偏微分方程式の境界値問題の差分法による求解
  \item ベクトルに逆行列を掛ける代わりに連立一次方程式を解く場合が多い
    \[ {\bf x} = A^{-1} {\bf b} \ \ \Rightarrow \ \ A {\bf x} = {\bf b} \]
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{ポアソン方程式の境界値問題}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item 二次元ポアソン方程式
    \[ \frac{\partial^2 u(x,y)}{\partial x^2} + \frac{\partial^2 u(x,y)}{\partial y^2} = f(x,y) \qquad 0 \le x \le 1, \ 0 \le y \le 1\]
  \item ディリクレ型境界条件: $u(x,y) = g(x,y)$ on $\partial \Omega$
  \item 有限差分法により離散化
    \begin{itemize}
    \item $x$方向、$y$方向をそれぞれ$n$等分: $(x_i,y_j) = (i/n, j/n)$
    \item $(n+1)^2$個の格子点の上で$u(x_i,y_j)=u_{ij}$が定義される
    \item そのうち$4n$個の値は境界条件で定まる
    \item ポアソン方程式を中心差分で近似 ($h=1/n$)
      \[
      \frac{u_{i+1,j}-2u_{ij}+u_{i-1,j}}{h^2} + \frac{u_{i,j+1}-2u_{ij}+u_{i,j-1}}{h^2} = f_{ij}
      \]
      残り$(n-1)^2$個の未知数に対する連立一次方程式
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{ポアソン方程式の境界値問題}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item ノイマン型境界条件の場合
    \begin{itemize}
    \item 境界上で$u(x,y)$の微分が定義される。
    \item 例) $\partial u(0,y) / \partial x = h(0,y)$
    \end{itemize}
  \item 境界条件を差分近似で表す
    \[
    \frac{u_{1j} - u_{0j}}{h} = h_{0j} \qquad j=1 \cdots (n-1)
    \]
    $(n+1)^2-4$個の未知数に対して、ポアソン方程式の差分近似とあわせて、合計$(n-1)^2+4(n-1)=(n+1)^2-4$個の連立一次方程式
  \end{itemize}
\end{frame}

\section{連立一次方程式の直接解法}

\begin{frame}[t,fragile]{逆行列の「間違った」求め方}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item 線形代数の教科書に載っている公式
    \[
    A^{-1} = \frac{\tilde{A}}{|A|}
    \]
    $|A|$: $A$の行列式、$\tilde{A}$: $A$の余因子行列
  \item $n \times n$行列の行列式を定義通り計算すると、計算量〜$O(n!)$
  \item したがって、上の方法で逆行列を計算すると、計算量〜$O(n!)$
  \item $n=100$の場合: $n! \approx 9.3 \times 10^{157}$
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{逆行列の「正しい」求め方}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item 連立一次方程式 $A {\bf x} = {\bf e}_j$ を全ての${\bf e}_j$について解く
  \item Gaussの消去法による連立一次方程式の解法: 計算量〜$O(n^3)$
  \item Gaussの消去法の途中で出てくる下三角行列(L)と上三角行列(U)行列を再利用(LU分解)すれば、逆行列全体を求めるための計算量も$O(n^3)$
  \item 行列式も$O(n^3)$で計算可
  \item $n=100$の場合: $n^3 = 10^6 \ll 9.3 \times 10^{157}$
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{ガウスの消去法}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item 解くべき連立方程式
    \begin{align*}
    a_{11}^{(1)} x_1 + a_{12}^{(1)} x_2 + a_{13}^{(1)} x_3 + \cdots + a_{1n}^{(1)} x_n &= b_{1}^{(1)} \\
    a_{21}^{(1)} x_1 + a_{22}^{(1)} x_2 + a_{23}^{(1)} x_3 + \cdots + a_{2n}^{(1)} x_n &= b_{2}^{(1)} \\
    a_{31}^{(1)} x_1 + a_{32}^{(1)} x_2 + a_{33}^{(1)} x_3 + \cdots + a_{3n}^{(1)} x_n &= b_{3}^{(1)} \\
    \cdots \\
    a_{n1}^{(1)} x_1 + a_{n2}^{(1)} x_2 + a_{n3}^{(1)} x_3 + \cdots + a_{nn}^{(1)} x_n &= b_{n}^{(1)}
    \end{align*}
  \item ある行を定数倍しても、方程式の解は変わらない
  \item ある行の定数倍を他の行から引いても、方程式の解は変わらない
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{ガウスの消去法}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item 1行目を$m_{i1} = a_{i1}^{(1)}/a_{11}^{(1)}$倍して、$i$行目($i \ge 2$)から引く
    \begin{align*}
    a_{11}^{(1)} x_1 + a_{12}^{(1)} x_2 + a_{13}^{(1)} x_3 + \cdots + a_{1n}^{(1)} x_n &= b_{1}^{(1)} \\
    a_{22}^{(2)} x_2 + a_{23}^{(2)} x_3 + \cdots + a_{2n}^{(2)} x_n &= b_{2}^{(2)} \\
    a_{32}^{(2)} x_2 + a_{33}^{(2)} x_3 + \cdots + a_{3n}^{(2)} x_n &= b_{3}^{(2)} \\
    \cdots \\
    a_{n2}^{(2)} x_2 + a_{n3}^{(2)} x_3 + \cdots + a_{nn}^{(2)} x_n &= b_{n}^{(2)}
    \end{align*}
  \item ここで
    \begin{align*}
      a_{ij}^{(2)} &= a_{ij}^{(1)} - m_{i1} a_{1j}^{(1)} \qquad i \ge 2, j \ge 2 \\
      b_{i}^{(2)} &= b_{i}^{(1)} - m_{i1} b_{1}^{(1)} \qquad i \ge 2
    \end{align*}
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{ガウスの消去法}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item 2行目を$m_{i2} = a_{i2}^{(2)}/a_{22}^{(2)}$倍して、$i$行目($i \ge 3$)から引く
    \begin{align*}
    a_{11}^{(1)} x_1 + a_{12}^{(1)} x_2 + a_{13}^{(1)} x_3 + \cdots + a_{1n}^{(1)} x_n &= b_{1}^{(1)} \\
    a_{22}^{(2)} x_2 + a_{23}^{(2)} x_3 + \cdots + a_{2n}^{(2)} x_n &= b_{2}^{(2)} \\
    a_{33}^{(3)} x_3 + \cdots + a_{3n}^{(3)} x_n &= b_{3}^{(3)} \\
    \cdots \\
    a_{n3}^{(3)} x_3 + \cdots + a_{nn}^{(3)} x_n &= b_{n}^{(3)}
    \end{align*}
  \item ここで
    \begin{align*}
      a_{ij}^{(3)} &= a_{ij}^{(2)} - m_{i2} a_{2j}^{(2)} \qquad i \ge 3, j \ge 3 \\
      b_{i}^{(3)} &= b_{i}^{(2)} - m_{i2} b_{2}^{(2)} \qquad i \ge 3
    \end{align*}
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{ガウスの消去法}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item 最終的には、左辺が右上三角形をした連立方程式となる
    \begin{align*}
    a_{11}^{(1)} x_1 + a_{12}^{(1)} x_2 + a_{13}^{(1)} x_3 + \cdots + a_{1n}^{(1)} x_n &= b_{1}^{(1)} \\
    a_{22}^{(2)} x_2 + a_{23}^{(2)} x_3 + \cdots + a_{2n}^{(2)} x_n &= b_{2}^{(2)} \\
    a_{33}^{(3)} x_3 + \cdots + a_{3n}^{(3)} x_n &= b_{3}^{(3)} \\
    \cdots \\
    a_{n-1,n-1}^{(n-1)} x_{n-1} + a_{n-1,n}^{(n-1)} x_n &= b_{n-1}^{(n-1)} \\
    a_{nn}^{(n)} x_n &= b_{n}^{(n)}
    \end{align*}
  \item これを下から順に解いていけばよい(後退代入)
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{練習問題}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item 次の連立方程式をガウスの消去法で(手で)解け
    \begin{align*}
      \begin{pmatrix} 1 & 4 & 7 \\ 2 & 5 & 8 \\ 3 & 6 & 10 \end{pmatrix} \begin{pmatrix} x_1 \\ x_2 \\ x_3 \end{pmatrix} = \begin{pmatrix} 18 \\ 24 \\ 31 \end{pmatrix}
    \end{align*}
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{ガウスの消去法のコード}
\begin{lstlisting}
for (k = 0; k < n; ++k) {
  for (i = k + 1; i < n; ++i) {
    for (j = k + 1; j < n; ++j) {
      a[i][j] -= a[k][j] * a[i][k] / a[k][k];
    }
    b[i] -= b[k] * a[i][k] / a[k][k];
  }
}
for (k = n-1; k >= 0; --k) {
  for (j = k + 1; j < n; ++j) {
    b[k] -= a[k][j] * b[j];
  }
  b[k] /= a[k][k];
}
\end{lstlisting}
\begin{itemize}
\item C言語では配列の添字が0から始まることに注意
\end{itemize}
\end{frame}

\begin{frame}[t,fragile]{ピボット選択}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item ガウスの消去法の途中で$a_{kk}^{(k)}$が零になると、計算を先に進めることができなくなる
  \item 行を入れ替えても、方程式の解は変わらない $\Rightarrow$ $k$行以降で、$a_{ik}^{(k)}$が非零の行と入れ替える (ピボット選択)
  \item 実際のコードでは、情報落ちを防ぐため、$a_{kk}^{(k)}$が零でない場合でも、$a_{ik}^{(k)}$の絶対値が最大の行と入れ替える
  \item ピボット選択が必要となる例
    \begin{align*}
      \begin{pmatrix} 1 & 2 & 3 \\ 3 & 6 & 4 \\ 4 & 6 & 7 \end{pmatrix} \begin{pmatrix} x_1 \\ x_2 \\ x_3 \end{pmatrix} = \begin{pmatrix} 8 \\ 19 \\ 23 \end{pmatrix}
    \end{align*}
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{ガウスの消去法の行列表示}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item $a_{kk}^{(k)}$を用いた$a_{ik}^{(k)}$ ($i>k$)の消去は、方程式の両辺から
    \begin{align*}
      M_k = 
      \begin{pmatrix}
        1 & \\
        0 & 1 \\
        0 & 0 & \ddots \\
        \vdots & \vdots & & 1 \\
        \vdots & \vdots & & -m_{k+1,k} & 1 & \\
        \vdots & \vdots & & -m_{k+2,k} & 0 & \ddots \\
        \vdots & \vdots & & \vdots & \vdots & & 1 & \\
        0 & 0 & \hdots & -m_{nk} & 0 & \hdots & 0 & 1
      \end{pmatrix}
    \end{align*}
    を掛けるのと等価: $M_k A^{(k)} = A^{(k+1)}$、$M_k {\bf b}^{(k)} = {\bf b}^{(k+1)}$
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{LU分解}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item $M_k$の逆行列
    \begin{align*}
      L_k = M_k^{-1} = 
      \begin{pmatrix}
        1 & \\
        0 & 1 \\
        0 & 0 & \ddots \\
        \vdots & \vdots & & 1 \\
        \vdots & \vdots & & m_{k+1,k} & 1 & \\
        \vdots & \vdots & & m_{k+2,k} & 0 & \ddots \\
        \vdots & \vdots & & \vdots & \vdots & & 1 & \\
        0 & 0 & \hdots & m_{nk} & 0 & \hdots & 0 & 1
      \end{pmatrix}
    \end{align*}
    から$L=L_1L_2\cdots L_n$を定義すると、$L$は下三角行列、また$U = A^{(n)}$ (上三角行列)とすると、$A = LU$
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{LU分解}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item LU分解による連立一次方程式の解法
    \begin{itemize}
    \item 方程式は$A{\bf x} = LU{\bf x} = {\bf b}$と書ける
    \item まず、$L{\bf y} = {\bf b}$を解いて、${\bf y}$を求める(前進代入)
    \item 次に、$U{\bf x} = {\bf y}$を解いて、${\bf x}$を求める(後退代入)
    \end{itemize}
  \item 計算量はガウスの消去法と変わらない
  \item 一度LU分解をしておけば、異なる${\bf b}$に対する解も簡単に求められる
  \item 行列式は$U$の対角成分の積で与えられる
  \end{itemize}
\end{frame}

\section{反復法}

\begin{frame}[t,fragile]{直接法と反復法}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item 直接法: 連立方程式を有限回数($\sim n^3$)の手間で直接解く
  \item 反復法: $A{\bf x}={\bf b}$を、等価な${\bf x} = \phi({\bf x}) = M{\bf x} + {\bf c}$の形に変形し、適当な初期値${\bf x}_0$から出発して、${\bf x}^{(k+1)} = \phi({\bf x}^{(k)})$を繰り返して解を求める
    \begin{itemize}
    \item 欠点: 有限回数では終わらない (あらかじめ定めた収束条件が満たされるまで反復)
    \item 利点: 行列ベクトル積$M{\bf x}$が計算できさえすればよい。特に$M$が疎行列の場合には、$M{\bf x}$は非常に高速に計算できる可能性がある。メモリの点でも有利
    \item 利点: 直接法に比べて、プログラムも比較的単純になる場合が多い
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{反復法}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item 行列$A$を対角行列$D$、左下三角行列$E$、右上三角行列$F$の和に分解
    \[
    A{\bf x} = (D + E + F){\bf x} = {\bf b}
    \]
  \item ヤコビ法: 対角成分以外を右辺に移す
    \[
      {\bf x}^{(k+1)} = D^{-1} ({\bf b} - (E+F) {\bf x}^{(k)}) = -D^{-1}(E+F){\bf x}^{(k)} + D^{-1} {\bf b}
      \]
    \item ガウスザイデル法: ヤコビ法で右辺の${\bf x}$の値として、各段階ですでに得られている最新のものを使う
    \begin{align*}
      {\bf x}^{(k+1)} &= D^{-1} ({\bf b} - E{\bf x}^{(k+1)} - F{\bf x}^{(k)}) \\
      {\bf x}^{(k+1)} &= -(D+E)^{-1} F{\bf x}^{(k)} + (D+E)^{-1}{\bf b}
    \end{align*}
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{反復法}
  \begin{itemize}
    \setlength{\itemsep}{1em}
  \item SOR (Successive Over-Relaxation)法: ガウスザイデル法における修正量に1より大きな値($\omega$)を掛け、補正を加速
    \begin{align*}
      {\bf \xi}^{(k+1)} &= D^{-1} ({\bf b} - E{\bf x}^{(k+1)} - F{\bf x}^{(k)}) \\
      {\bf x}^{(k+1)} &= {\bf x}^{(k)} + \omega({\bf \xi}^{(k+1)} - {\bf x}^{(k)})
    \end{align*}
    ${\bf \xi}^{(k+1)}$を消去すると
    \begin{align*}
      {\bf x}^{(k+1)} = &(I+\omega D^{-1}E)^{-1} \{(1-\omega)I - \omega D^{-1} F\}{\bf x}^{(k)} \\ &+ \omega(D+\omega E)^{-1}{\bf b}
    \end{align*}
    \item 反復法は常に収束するとは限らない
    \item 行列$A$が対角優位、あるいは正定値対称行列の場合には収束が保証される
  \end{itemize}
\end{frame}

\section{実習その3}

\begin{frame}[t,fragile]{EX3-1: サンプルプログラムの実行}
  \begin{itemize}
    %\setlength{\itemsep}{1em}
  \item[3-1-1] ガウスの消去法のサンプルプログラム(\href{https://github.com/todo-group/computer-experiments/exercise/linear_system/gauss.c}{exercise/linear\_system/gauss.c})をコンパイル・実行せよ。実行時にコマンドライン引数に行列の内容が書かれたファイル名({\tt input1.dat})を指定する必要があることに注意
\begin{lstlisting}
$ cc gauss.c -o gauss
$ ./gauss input1.dat
\end{lstlisting}
  \item[3-1-2] LU分解のサンプルプログラム(\href{https://github.com/todo-group/computer-experiments/exercise/linear_system/lu_decomp.c}{exercise/linear\_system/lu\_decomp.c})をコンパイル・実行せよ。コンパイル時にLAPACKをリンク({\tt -llapack})する必要があることに注意(ハンドブック3.1.6節)
\begin{lstlisting}
$ cc lu_decomp.c -o lu_decomp -llapack
$ ./lu_decomp input1.dat
\end{lstlisting}
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{EX3-2: ピボット選択、境界条件}
  \begin{itemize}
    %\setlength{\itemsep}{1em}
  \item[3-2-1] \href{https://github.com/todo-group/computer-experiments/exercise/linear_system/gauss.c}{exercise/linear\_system/gauss.c}では、ピボット選択を行っていないため、入力が{\tt input2.dat}の場合には正しい解が得られない。ピボット選択を行うよう{\tt gauss.c}を修正せよ
  \item[3-2-2] \href{https://github.com/todo-group/computer-experiments/exercise/linear_system/laplace_lu.c}{exercise/linear\_system/laplace\_lu.c}では、ディリクレ型の境界条件[$u(0,y) = \sin(\pi y)$, $u(x,0)=u(x,1)=u(1,y)=0$]のもとでのラプラス方程式の解をLU分解により求めている。境界条件を変えてみて解がどのように変化するか、Gnuplotを用いてプロットして確認せよ(Gnuplotの{\tt splot}コマンドを使う)
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{EX3-3: ヤコビ法、ガウス・ザイデル法、SOR法}
  \begin{itemize}
    %\setlength{\itemsep}{1em}
  \item[3-3-1] \href{https://github.com/todo-group/computer-experiments/exercise/linear_system/laplace_jacobi.c}{exercise/linear\_system/laplace\_jacobi.c}は、作りかけのヤコビ法のプログラムである。収束判定のコードを追加し、プログラムを完成せよ。計算結果や計算速度を{\tt laplace\_lu.c}と比較せよ
  \item[3-3-2] ヤコビ法のプログラム({\tt lapalace\_jacobi.c})を元に、ガウス・ザイデル法、SOR法のプログラムを作成せよ。収束までの回数を比較せよ。
特にSOR法の場合、パラメータ$\omega$の選び方により、どのように収束回数が変化するか観察し、最適な$\omega$の値について考察せよ
  \end{itemize}
\end{frame}

\end{document}
